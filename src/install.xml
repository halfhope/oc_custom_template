<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>Custom Templates module</name>
    <version>1.3</version>
    <author>shtt.blog</author>
    <code>Custom Templates module</code>
    <link>https://opencartforum.com/files/file/1986-%D0%BF%D0%B5%D1%80%D1%81%D0%BE%D0%BD%D0%B0%D0%BB%D0%B8%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B5-%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD%D1%8B/</link>
    <!-- custom -->
    <file path="catalog/controller/checkout/cart.php">
        <operation error="skip">
            <search><![CDATA[$this->response->setOutput($this->load->view($this->config->get('config_template') . '/template/checkout/cart.tpl', $data));]]></search>
            <add position="replace"><![CDATA[
            $template = $this->config->get('config_template') . '/template/checkout/cart.tpl';

            // Custom template module

            $custom_template_module = $this->config->get('custom_template_module');

            if(!empty($custom_template_module)){

                library('custom_template');
                $custom_template = new CustomTemplate($this->registry);
                $this->registry->set('custom_template', $custom_template);
                
                $customer_group_id = $this->customer->getGroupId();
                
                foreach ($custom_template_module as $key => $module) {
                    if($module['type'] == 0){
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){
                            if ($this->custom_template->filterLayouts($module)){

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }
                        }
                    }
                }

            }
            $this->response->setOutput($this->load->view($template, $data));
            // Custom template module
            ]]></add>
        </operation>
    </file>
    <file path="catalog/controller/information/contact.php">
        <operation error="skip">
            <search><![CDATA[$this->response->setOutput($this->load->view($this->config->get('config_template') . '/template/information/contact.tpl', $data));]]></search>
            <add position="replace"><![CDATA[
            $template = $this->config->get('config_template') . '/template/information/contact.tpl';

            // Custom template module

            $custom_template_module = $this->config->get('custom_template_module');

            if(!empty($custom_template_module)){

                library('custom_template');
                $custom_template = new CustomTemplate($this->registry);
                $this->registry->set('custom_template', $custom_template);
                
                $customer_group_id = $this->customer->getGroupId();
                
                foreach ($custom_template_module as $key => $module) {
                    if($module['type'] == 0){
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){
                            if ($this->custom_template->filterLayouts($module)){

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }
                        }
                    }
                }

            }
            $this->response->setOutput($this->load->view($template, $data));
            // Custom template module
            ]]></add>
        </operation>
    </file>
    <!-- common -->
    <file path="catalog/controller/common/home.php">
        <operation error="skip">
            <search><![CDATA[$this->response->setOutput($this->load->view($this->config->get('config_template') . '/template/common/home.tpl', $data));]]></search>
            <add position="replace"><![CDATA[
            $template = $this->config->get('config_template') . '/template/common/home.tpl';

            // Custom template module

            $custom_template_module = $this->config->get('custom_template_module');

            if(!empty($custom_template_module)){

                library('custom_template');
                $custom_template = new CustomTemplate($this->registry);
                $this->registry->set('custom_template', $custom_template);
                
                $customer_group_id = $this->customer->getGroupId();
                
                foreach ($custom_template_module as $key => $module) {
                    if($module['type'] == 0){
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){
                            if ($this->custom_template->filterLayouts($module)){

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }
                        }
                    }
                }

            }
            $this->response->setOutput($this->load->view($template, $data));
            // Custom template module
            ]]></add>
        </operation>
    </file>
    <file path="catalog/controller/product/category.php">
        <operation error="log">
            <search position="replace"><![CDATA[$this->response->setOutput($this->load->view($this->config->get('config_template') . '/template/product/category.tpl', $data));]]></search>
            <add><![CDATA[
                $template = $this->config->get('config_template') . '/template/product/category.tpl';

                // Custom template module

                $custom_template_module = $this->config->get('custom_template_module');

                if(!empty($custom_template_module)){
                    
                    library('custom_template');
                    $custom_template = new CustomTemplate($this->registry);
                    $this->registry->set('custom_template', $custom_template);
                    
                    $customer_group_id = $this->customer->getGroupId();
                    
                    foreach ($custom_template_module as $key => $module) {
                        if($module['type'] == 0){
                            if ($this->custom_template->filterCommon($module, $customer_group_id)){
                                if ($this->custom_template->filterLayouts($module)){

                                    if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                        $template = $module['template_name'];
                                    }

                                }
                            }
                        }
                    }
                    foreach ($custom_template_module as $key => $module) {
                        if ($module['type'] == 1) {
                            if ($this->custom_template->filterCommon($module, $customer_group_id)){
                                if ($this->custom_template->filterCategories($module, $category_id)) { 

                                    if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                        $template = $module['template_name'];
                                    }

                                }
                            }
                        }
                    }
                }            
                $this->response->setOutput($this->load->view($template, $data));
                // Custom template module
            ]]></add>
        </operation>
    </file>
    <file path="catalog/controller/product/product.php">
        <operation error="skip">
            <search><![CDATA[$this->response->setOutput($this->load->view($this->config->get('config_template') . '/template/product/product.tpl', $data));]]></search>
            <add position="replace"><![CDATA[
            $template = $this->config->get('config_template') . '/template/product/product.tpl';

            // Custom template module

            $custom_template_module = $this->config->get('custom_template_module');

            if(!empty($custom_template_module)){
            
                library('custom_template');
                $custom_template = new CustomTemplate($this->registry);
                $this->registry->set('custom_template', $custom_template);
                
                $customer_group_id = $this->customer->getGroupId();

                foreach ($custom_template_module as $key => $module) {
                    if($module['type'] == 0){
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){
                            if ($this->custom_template->filterLayouts($module)){

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }
                        }
                    }
                }

                if(isset($this->request->get['path'])){
                    foreach ($custom_template_module as $key => $module) {
                        if ($module['type'] == 5) {
                            if ($this->custom_template->filterCommon($module, $customer_group_id)){

                                $category_id = explode('_', $this->request->get['path']);
                                $category_id = (int)end($category_id);
                                
                                if ($this->custom_template->filterProductCategories($module, $category_id)){

                                    if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                        $template = $module['template_name'];
                                    }

                                }

                            }
                        }
                    }
                }

                foreach ($custom_template_module as $key => $module) {
                    if ($module['type'] == 6) {
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){

                            $manufacturer_id = $product_info['manufacturer_id'];

                            if ($this->custom_template->filterProductManufacturers($module, $manufacturer_id)) {

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }

                        }

                    }
                }   

                foreach ($custom_template_module as $key => $module) {
                    if (($module['type'] == 2) && !empty($module['products'])) {
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){
                            if ($this->custom_template->filterProducts($module, $product_id)) {

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }
                        }
                    }
                }
            }
            $this->response->setOutput($this->load->view($template, $data));                
            // Custom template module
            ]]></add>
        </operation>
    </file>
    <file path="catalog/controller/information/information.php">
        <operation error="skip">
            <search><![CDATA[$this->response->setOutput($this->load->view($this->config->get('config_template') . '/template/information/information.tpl', $data));]]></search>
            <add position="replace"><![CDATA[
            $template = $this->config->get('config_template') . '/template/information/information.tpl';

            // Custom template module

            $custom_template_module = $this->config->get('custom_template_module');

            if(!empty($custom_template_module)){

                library('custom_template');
                $custom_template = new CustomTemplate($this->registry);
                $this->registry->set('custom_template', $custom_template);
                
                $customer_group_id = $this->customer->getGroupId();

                foreach ($custom_template_module as $key => $module) {
                    if($module['type'] == 0){
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){
                            if ($this->custom_template->filterLayouts($module)){

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }
                        }
                    }
                }

                foreach ($custom_template_module as $key => $module) {
                    if ($module['type'] == 3) {
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){
                            if ($this->custom_template->filterInformations($module, $information_id)){

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }
                        }
                    }
                }
            }
            $this->response->setOutput($this->load->view($template, $data));
            // Custom template module
            ]]></add>
        </operation>
    </file>
    <file path="catalog/controller/product/manufacturer.php">
        <operation error="skip">
            <search><![CDATA[$this->response->setOutput($this->load->view($this->config->get('config_template') . '/template/product/manufacturer_info.tpl', $data));]]></search>
            <add position="replace"><![CDATA[
            $template = $this->config->get('config_template') . '/template/product/manufacturer_info.tpl';

            // Custom template module

            $custom_template_module = $this->config->get('custom_template_module');

            if(!empty($custom_template_module)){

                library('custom_template');
                $custom_template = new CustomTemplate($this->registry);
                $this->registry->set('custom_template', $custom_template);
                
                $customer_group_id = $this->customer->getGroupId();
                
                foreach ($custom_template_module as $key => $module) {
                    if($module['type'] == 0){
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){
                            if ($this->custom_template->filterLayouts($module)){

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }
                        }
                    }
                }

                foreach ($custom_template_module as $key => $module) {
                    if ($module['type'] == 4) {
                        if ($this->custom_template->filterCommon($module, $customer_group_id)){
                            if ($this->custom_template->filterManufacturers($module, $manufacturer_id)){

                                if (file_exists(DIR_TEMPLATE . $module['template_name'])) {
                                    $template = $module['template_name'];
                                }

                            }
                        }
                    }
                }
            }
            $this->response->setOutput($this->load->view($template, $data));
            // Custom template module
            ]]></add>
        </operation>
    </file>

</modification>